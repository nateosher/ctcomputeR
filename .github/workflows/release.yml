name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write # to create GitHub Releases + upload assets

jobs:
  build-src:
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.out.outputs.pkg }}
    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck, any::rextendr
          needs: check

      # Optional but common if you're using roxygen / rextendr bindings generation
      - name: Generate docs (optional)
        run: |
          R -q -e 'if (requireNamespace("rextendr", quietly=TRUE)) rextendr::document()'
          R -q -e 'if (requireNamespace("roxygen2", quietly=TRUE)) roxygen2::roxygenise()'

      - name: Build source tarball
        run: R CMD build .

      - name: Determine tarball name
        id: out
        run: |
          echo "pkg=$(ls -1 *.tar.gz | head -n 1)" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: r-src
          path: ${{ steps.out.outputs.pkg }}

  build-win-binary:
    runs-on: windows-latest
    needs: build-src
    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
      - uses: r-lib/actions/setup-rtools@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rextendr, any::rcmdcheck, any::devtools
          needs: check

      - uses: actions/download-artifact@v4
        with:
          name: r-src

      - name: Build Windows binary from source tarball
        shell: pwsh
        run: |
          $tar = Get-ChildItem -Filter *.tar.gz | Select-Object -First 1
          R CMD INSTALL --build $tar.Name

      - uses: actions/upload-artifact@v4
        with:
          name: r-win
          path: "*.zip"

  github-release:
    runs-on: ubuntu-latest
    needs: [build-src, build-win-binary]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: r-src
          path: dist
      - uses: actions/download-artifact@v4
        with:
          name: r-win
          path: dist

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
