name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write # to create GitHub Releases + upload assets

jobs:
  build-src:
    runs-on: ubuntu-latest
    outputs:
      pkg: ${{ steps.out.outputs.pkg }}
    steps:
      - uses: actions/checkout@v4

      - name: Assert tag matches DESCRIPTION Version
        shell: bash
        run: |
          # Tag is like refs/tags/v0.3.1 â†’ we want 0.3.1
          TAG_VER="${GITHUB_REF_NAME#v}"

          # Read Version: x.y.z from DESCRIPTION
          DESC_VER="$(awk -F': *' '$1=="Version"{print $2}' DESCRIPTION | tr -d '\r')"

          echo "Tag version:         $TAG_VER"
          echo "DESCRIPTION version: $DESC_VER"

          if [ "$TAG_VER" != "$DESC_VER" ]; then
            echo "::error::Tag (v$TAG_VER) does not match DESCRIPTION Version ($DESC_VER)"
            exit 1
          fi

      - uses: r-lib/actions/setup-r@v2
      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck, any::rextendr, any::devtools
          needs: check

      # Optional but common if you're using roxygen / rextendr bindings generation
      - name: Generate docs (optional)
        run: |
          R -q -e 'if (requireNamespace("rextendr", quietly=TRUE)) rextendr::document()'
          R -q -e 'if (requireNamespace("roxygen2", quietly=TRUE)) roxygen2::roxygenise()'

      - name: Build source tarball
        run: R CMD build .

      - name: Determine tarball name
        id: out
        run: |
          echo "pkg=$(ls -1 *.tar.gz | head -n 1)" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v4
        with:
          name: r-src
          path: ${{ steps.out.outputs.pkg }}

  build-win-binary:
    runs-on: windows-latest
    needs: build-src
    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rextendr, any::rcmdcheck, any::devtools
          needs: check

      - uses: actions/download-artifact@v4
        with:
          name: r-src

      - name: Build Windows binary from source tarball
        shell: pwsh
        run: |
          $tar = Get-ChildItem -Filter *.tar.gz | Select-Object -First 1
          R.exe CMD INSTALL --build "$($tar.FullName)"

      - uses: actions/upload-artifact@v4
        with:
          name: r-win
          path: "*.zip"

  github-release:
    runs-on: ubuntu-latest
    needs: [build-src, build-win-binary]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: r-src
          path: dist
      - uses: actions/download-artifact@v4
        with:
          name: r-win
          path: dist

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
